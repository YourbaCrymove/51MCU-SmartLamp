# 智能台灯项目技术说明文档

## 一、PWM调光技术深度解析

### 1.1 物理原理与视觉暂留效应

LED调光的核心基于**脉冲宽度调制(PWM)**技术和**人眼视觉暂留**特性：

```c
// PWM调光物理原理
周期T = 高电平时间(Ton) + 低电平时间(Toff)
占空比D = Ton / T × 100%
感知亮度 ∝ 占空比D
```

**视觉暂留效应**：当PWM频率高于50Hz时，人眼无法分辨LED的快速开关状态，而是将光脉冲积分感知为连续亮度。这就是为什么单片机通过快速切换LED状态能够实现平滑调光。

### 1.2 软件PWM实现方案

#### 定时器配置
```c
// 定时器0初始化 - 100μs中断周期
void timer0Init(void) {
    TMOD &= 0xF0; TMOD |= 0x01;     // 模式1，16位定时器
    TH0 = (65536 - 92) / 256;       // 11.0592MHz晶振计算
    TL0 = (65536 - 92) % 256;       // 100μs定时初值
    EA = 1; ET0 = 1; TR0 = 1;       // 开启中断和定时器
}
```

#### PWM输出算法
```c
// 中断服务函数中的PWM处理
void timer0_ISR(void) interrupt 1 {
    systemData.pwmCount++;
    systemData.pwmCount %= 100;  // 100级PWM分辨率
    
    if(systemData.pwmCount < systemData.lightGrade[systemData.lightState]) {
        LED_MAIN = 0;  // 点亮
    } else {
        LED_MAIN = 1;  // 熄灭
    }
}
```

#### 亮度等级定义
```c
// 5档亮度对应占空比
systemData.lightGrade[0] = 0;    // 关闭 - 0%
systemData.lightGrade[1] = 25;   // 弱光 - 25%  
systemData.lightGrade[2] = 50;   // 中光 - 50%
systemData.lightGrade[3] = 75;   // 强光 - 75%
systemData.lightGrade[4] = 100;  // 最亮 - 100%
```

### 1.3 参数优化设计

**频率选择依据**：
- 100Hz PWM频率 = 100μs × 100级 = 10ms周期
- 远高于人眼临界闪烁频率(50Hz)
- 保证亮度平滑无闪烁

**占空比精度**：
- 100级分辨率，1%步进精度
- 平衡了控制精度和计算复杂度

## 二、传感器数据采集系统

### 2.1 XPT2046 ADC驱动原理

#### SPI通信时序
```c
unsigned int xpt2046_read_adc_value(unsigned char cmd) {
    CS = 0;                        // 片选使能
    xpt2046_wirte_data(cmd);       // 发送控制命令
    for(i=6; i>0; i--);            // 转换等待时间
    CLK = 1; _nop_(); CLK = 0;     // 清除BUSY标志
    adc_value = xpt2046_read_data(); // 读取12位数据
    CS = 1;                        // 释放片选
    return adc_value;              // 返回0-4095
}
```

#### 控制命令字格式
- **通道选择**：0xA4 - 光敏电阻通道
- **分辨率**：12位精度(0-4095)
- **参考电压**：内部2.5V基准

### 2.2 环境光自适应算法

```c
void lampAutoControl(void) {
    systemData.lightIntensity = xpt2046_read_adc_value(0xA4);
    
    // 光线越弱，台灯越亮 - 反向调节逻辑
    if(systemData.lightIntensity < LIGHT_LOWEST) {
        systemData.lightState = LAMP_HIGHEST;    // 最暗环境 → 最亮
    } else if(systemData.lightIntensity < LIGHT_LOW) {
        systemData.lightState = LAMP_HIGH;       // 较暗环境 → 亮
    } else if(systemData.lightIntensity < LIGHT_MEDIUM) {
        systemData.lightState = LAMP_MEDIUM;     // 中等环境 → 中亮
    } else if(systemData.lightIntensity < LIGHT_HIGH) {
        systemData.lightState = LAMP_LOW;        // 较亮环境 → 弱亮
    } else {
        systemData.lightState = LAMP_CLOSE;      // 明亮环境 → 关闭
    }
}
```

#### 光线阈值定义
```c
#define LIGHT_LOWEST    819   // 20% - 最暗阈值
#define LIGHT_LOW       1683  // 40% - 较暗阈值  
#define LIGHT_MEDIUM    2457  // 60% - 中等阈值
#define LIGHT_HIGH      3276  // 80% - 较亮阈值
#define LIGHT_MAX       4095  // 100% - 最亮阈值
```

## 三、系统状态机设计

### 3.1 按键状态机 - 四状态消抖机制

```c
typedef enum {
    KEY_STATE_IDLE,           // 空闲状态
    KEY_STATE_DEBOUNCE_PRESS, // 按下消抖
    KEY_STATE_PRESSED,        // 按下确认  
    KEY_STATE_DEBOUNCE_RELEASE // 释放消抖
} keyState;
```

#### 状态转移逻辑
```
空闲状态 → 检测到按键 → 按下消抖(20ms) → 确认按下 → 返回键值
    ↑                                          ↓
释放消抖(20ms) ← 检测释放 ← 按下确认状态
```

### 3.2 系统工作模式状态机

#### 模式切换逻辑
```c
void stateMachine(void) {
    switch(keyNumber) {
        case 1:  // 模式切换键
            systemData.systemState = (systemData.systemState == MANUAL) ? AUTO : MANUAL;
            
            if(systemData.systemState == AUTO) {
                systemData.lightState = LAMP_MEDIUM;  // 自动模式重置
                systemData.timeCount = 0;             // 清零计时器
                systemFlag.countFlag = 1;             // 开始人走计时
            } else {
                systemFlag.humanFlag = 1;             // 手动模式默认有人
            }
            break;
    }
}
```

## 四、定时器系统架构

### 4.1 多任务时间基准

系统采用**单一定时器多任务分时**架构：

```c
void timer0_ISR(void) interrupt 1 {
    // 任务1：PWM调光输出
    systemData.pwmCount++;
    systemData.pwmCount %= 100;
    
    // 任务2：人走计时
    if(systemFlag.countFlag) {
        systemFlag.count++;
        if(systemFlag.count == 10000) {  // 100us × 10000 = 1秒
            systemFlag.count = 0;
            systemData.timeCount++;
            
            if(systemData.timeCount >= LAMP_CLOSE_TIME) {
                systemFlag.countFlag = 0;
                systemFlag.humanFlag = 0;  // 标记无人，关闭台灯
            }
        }
    }
    
    // 任务3：LED状态控制
    if(systemFlag.humanFlag) {
        LED_MAIN = (systemData.pwmCount < lightGrade[lightState]) ? 0 : 1;
    } else {
        LED_MAIN = 1;  // 无人状态强制关灯
    }
}
```

### 4.2 时间参数配置

| 时间参数 | 数值  | 计算依据         | 用途         |
| -------- | ----- | ---------------- | ------------ |
| 中断周期 | 100μs | 11.0592MHz/12/92 | 系统时间基准 |
| PWM周期  | 10ms  | 100μs × 100级    | 亮度调节周期 |
| 消抖时间 | 20ms  | 2×10ms周期       | 按键去抖动   |
| 关灯延时 | 30s   | 30×1000ms        | 人走灯灭延迟 |

## 五、硬件接口定义

### 5.1 引脚分配表

| 引脚   | 功能     | 外设           | 备注        |
| ------ | -------- | -------------- | ----------- |
| P2^0   | LED_MAIN | 主照明灯       | PWM调光输出 |
| P2^6   | LED1     | 自动模式指示灯 | 低电平有效  |
| P2^7   | LED2     | 手动模式指示灯 | 低电平有效  |
| P3^0-3 | 按键输入 | 4个独立按键    | 状态机消抖  |
| P3^4-7 | SPI接口  | XPT2046        | 光线传感器  |

### 5.2 电源与信号完整性

- **PWM驱动能力**：采用灌电流方式驱动LED，保证电流稳定性
- **ADC参考电压**：使用XPT2046内部2.5V基准，提高采样精度
- **按键上拉**：所有按键输入端口启用内部上拉电阻

## 六、性能指标与优化

### 6.1 系统性能参数

| 性能指标   | 数值   | 测试条件       |
| ---------- | ------ | -------------- |
| PWM频率    | 100Hz  | 11.0592MHz晶振 |
| 调光分辨率 | 100级  | 1%步进精度     |
| ADC采样率  | ~10kHz | 单次转换时间   |
| 响应时间   | <100ms | 按键到光变     |
| 待机功耗   | <10mA  | 无人关灯状态   |

### 6.2 算法优化策略

1. **中断优化**：所有耗时操作移至主循环，中断服务函数保持精简
2. **数据滤波**：ADC采样采用中值滤波，抑制噪声干扰
3. **状态缓存**：显示数据缓冲区减少数码管刷新开销
4. **条件编译**：关键参数通过宏定义便于调试和优化

---

**文档版本**：v1.0  
**最后更新**：2025-10-24  
**维护者**：YourbaCrymove