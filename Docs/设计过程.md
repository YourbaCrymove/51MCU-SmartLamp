# 智能台灯项目开发历程

##  项目起源

**学习目标：** 通过一个完整的嵌入式项目，系统掌握51单片机的综合应用能力，包括外设驱动、状态机设计、传感器数据处理等核心技术。

**选题原因：** 智能台灯项目具有很高的实用价值，同时涵盖了单片机开发的多个重要技术点，是检验学习成果的理想选择。

##  开发流程

### 第一阶段：核心功能搭建 - PWM调光系统

**目标：** 实现LED灯的基础亮度调节功能

**技术实现：**
- **定时器配置：** 使用定时器0，配置为100μs中断，为PWM提供精确的时间基准
- **PWM算法设计：** 在中断服务程序中实现0-99的计数器循环，通过比较计数值与亮度等级来控制LED亮灭
- **亮度等级定义：** 设计5档亮度（0%、25%、50%、75%、100%）对应的PWM占空比

**关键代码：**
```c
// PWM输出处理
systemData.pwmCount++;
systemData.pwmCount %= 100;  // 保持0-99范围

if(systemData.pwmCount < systemData.lightGrade[systemData.lightState]) {
    LED_MAIN = 0;  // 点亮主灯
} else {
    LED_MAIN = 1;  // 熄灭主灯
}
```

**验证结果：** 成功实现平滑无闪烁的5档亮度调节，为后续功能奠定基础。

### 第二阶段：手动模式与用户交互

**目标：** 建立完整的用户操作界面和手动控制功能

**功能实现：**
- **按键驱动开发：** 采用四状态机实现可靠的按键消抖
  - `KEY_STATE_IDLE` → `KEY_STATE_DEBOUNCE_PRESS` → `KEY_STATE_PRESSED` → `KEY_STATE_DEBOUNCE_RELEASE`
- **亮度档位控制：** 按键2增加亮度，按键3降低亮度，支持循环调节
- **模式指示灯：** 使用LED1/LED2分别指示自动/手动模式状态

**状态机设计亮点：**
```c
// 按键状态机确保每次按键只触发一次
case KEY_STATE_DEBOUNCE_PRESS:
    keyDebounceTimer++;
    if(keyDebounceTimer >= DEBOUNCE_TIME) {
        // 验证按键状态一致性，防止误触发
        if(confirmedKey == currentKey) {
            currentKeyState = KEY_STATE_PRESSED;
            keyNumber = confirmedKey;
        }
    }
    break;
```

### 第三阶段：自动模式与环境感知

**目标：** 实现基于环境光线强度的智能调光

**技术集成：**
- **XPT2046驱动：** 编写SPI通信协议，读取光敏电阻的ADC值
- **光线强度分级：** 将0-4095的ADC范围划分为5个亮度区间
- **自适应算法：** 遵循"光线越暗，台灯越亮"的智能逻辑

**智能调光算法：**
```c
void lampAutoControl(void) {
    if(systemData.systemState != AUTO || systemFlag.humanFlag == 0) {
        return;
    }
    
    systemData.lightIntensity = xpt2046_read_adc_value(0xA4);
    
    // 根据环境光强度自动选择合适亮度
    if(systemData.lightIntensity < LIGHT_LOWEST) {
        systemData.lightState = LAMP_HIGHEST;  // 环境最暗 → 台灯最亮
    } else if(systemData.lightIntensity < LIGHT_LOW) {
        systemData.lightState = LAMP_HIGH;
    }
    // ... 更多条件判断
}
```

### 第四阶段：人体检测模拟系统

**硬件限制与创新解决方案：**

**原计划：** 使用人体红外感应传感器
- **理想功能：** 自动检测人体存在，实现"人来灯亮、人走灯灭"
- **现实问题：** 缺乏实际传感器模块

**第一次替代方案：红外接收模块**
- **理论设计：** 通过遥控器按键模拟人体到来和离开
- **实践结果：** 解码失败，方案不可行

**最终方案：独立按键模拟**
- **实现逻辑：** 
  - 按键4按下 → 标记有人(`humanFlag = 1`)，开始计时
  - 30秒内无操作 → 自动标记无人(`humanFlag = 0`)，关闭台灯
- **技术实现：**
```c
// 人走计时处理
if(systemFlag.countFlag) {
    systemFlag.count++;
    if(systemFlag.count == 10000) {  // 100us × 10000 = 1秒
        systemData.timeCount++;
        if(systemData.timeCount == LAMP_CLOSE_TIME) {
            systemFlag.humanFlag = 0;  // 标记无人，关闭台灯
        }
    }
}
```

##  硬件资源整合

### 开发板限制与外接解决方案

**冲突模块：**
- 数码管与部分按键引脚重叠
- XPT2046接口与其它外设冲突

**外接方案：**
- 使用STM32面包板搭建扩展电路
- 通过杜邦线连接独立外设模块
- 重新规划引脚分配，确保各功能独立运行

### 最终硬件配置
- **主控：** STC89C52单片机
- **显示：** 4位共阳极数码管（外接）
- **传感：** 光敏电阻 + XPT2046 ADC模块（外接）
- **控制：** 4个独立按键
- **指示：** 3个LED（主灯 + 2个模式指示灯）

## 系统集成测试

### 功能验证流程
1. **基础调光测试：** 验证各档位亮度是否正常
2. **模式切换测试：** 检查手动/自动模式切换逻辑
3. **环境响应测试：** 验证光线变化时的自动调光
4. **人体模拟测试：** 测试按键模拟的人体检测功能
5. **稳定性测试：** 长时间运行检查系统稳定性

### 测试结果
- ✅ PWM调光平滑无闪烁
- ✅ 模式切换响应迅速
- ✅ 环境光自适应准确
- ✅ 人走灯灭延时精确
- ✅ 系统运行稳定可靠

## 项目总结

### 技术收获
1. **深入理解PWM原理**及其在调光中的应用
2. **掌握状态机设计模式**在嵌入式系统中的重要性
3. **学会硬件资源冲突的解决方案**
4. **实践模块化编程思想**，提高代码可维护性

### 经验教训
- 硬件选型前要充分考虑资源冲突问题
- 状态机设计能显著提高系统稳定性
- 模拟方案虽然可行，但真实传感器效果更佳

### 未来扩展
- 添加真实的人体红外传感器
- 集成蓝牙/WiFi远程控制
- 增加语音控制功能
- 实现更精细的亮度调节（0-100级）

---
**项目完成时间：** 2025年10月  
**开发者：** YourbaCrymove  
**技术栈：** C51、状态机、PWM、ADC采集、模块化设计